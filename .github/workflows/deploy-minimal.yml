name: ğŸš€ Deploy Fuseloja Minimal

on:
  # Disable automatic push trigger due to Git clone issues
  # push:
  #   branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if no changes'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'
  APP_NAME: 'fuseloja-minimal'
  DEPLOY_PATH: '/opt/fuseloja'

jobs:
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json

    - name: ğŸ”§ Install Frontend Dependencies
      working-directory: ./frontend
      run: npm ci --silent

    - name: ğŸ”§ Install Backend Dependencies
      working-directory: ./backend
      run: npm ci --silent

    - name: ğŸ—ï¸ Build Frontend
      working-directory: ./frontend
      run: |
        npm run build
        echo "âœ… Frontend build completed"

    - name: ğŸ§ª Test Backend Startup
      working-directory: ./backend
      env:
        NODE_ENV: test
        JWT_SECRET: test-secret-for-build
        DB_HOST: localhost
        DB_USER: test
        DB_PASSWORD: test
        DB_NAME: test
      run: |
        echo "Testing backend startup..."
        timeout 10s npm start || echo "âœ… Backend startup test completed"

    - name: ğŸ“Š Build Summary
      run: |
        echo "## ğŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Frontend build: $(du -sh frontend/dist | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Backend size: $(du -sh backend/src | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¦ Dependencies: $(ls backend/node_modules | wc -l) packages" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: ğŸš€ Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup deployment variables
      run: |
        echo "TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV
        echo "COMMIT_HASH=${GITHUB_SHA:0:7}" >> $GITHUB_ENV

    - name: ğŸš€ Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 600s
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Install system dependencies
          echo "ğŸ“¦ Installing system dependencies..."
          apt update -y
          apt install -y curl git wget unzip
          
          # Install Node.js 18 if not exists
          if ! command -v node &> /dev/null; then
            echo "ğŸ“¦ Installing Node.js 18..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
            apt install -y nodejs
          fi
          
          # Verify Node.js installation
          echo "âœ… Node.js version: $(node --version)"
          echo "âœ… NPM version: $(npm --version)"
          
          # Create directories
          mkdir -p ${{ env.DEPLOY_PATH }}
          cd ${{ env.DEPLOY_PATH }}
          
          # Backup current deployment
          if [ -d "current" ]; then
            echo "ğŸ“¦ Creating backup..."
            cp -r current backup_$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
            # Keep only last 3 backups
            ls -dt backup_* | tail -n +4 | xargs rm -rf 2>/dev/null || true
          fi
          
          # Clone repository (configure Git first for public repo)
          echo "ğŸ“¥ Cloning repository..."
          rm -rf fuseloja
          
          # Configure Git for non-interactive clone
          git config --global user.email "deploy@fuseloja.com"
          git config --global user.name "Deploy Bot"
          git config --global init.defaultBranch main
          
          # Try multiple clone methods
          if git clone https://github.com/fernandinhomartins40/fuseloja.git; then
            echo "âœ… HTTPS clone successful"
          elif git clone git://github.com/fernandinhomartins40/fuseloja.git; then
            echo "âœ… Git protocol clone successful"
          else
            echo "âŒ Git clone failed, trying wget fallback..."
            wget -O main.zip "https://github.com/fernandinhomartins40/fuseloja/archive/refs/heads/main.zip"
            if [ -f "main.zip" ]; then
              unzip -q main.zip
              mv fuseloja-main fuseloja
              rm main.zip
              echo "âœ… Wget fallback successful"
            else
              echo "âŒ All clone methods failed"
              exit 1
            fi
          fi
          
          if [ ! -d "fuseloja" ]; then
            echo "âŒ Repository directory not found after clone"
            exit 1
          fi
          
          cd fuseloja
          echo "âœ… Repository cloned successfully"
          
          # Install dependencies and build
          echo "ğŸ“¦ Installing dependencies..."
          
          # Backend
          cd backend
          if [ ! -f "package.json" ]; then
            echo "âŒ Backend package.json not found"
            exit 1
          fi
          npm ci --silent --production
          
          # Frontend
          cd ../frontend
          if [ ! -f "package.json" ]; then
            echo "âŒ Frontend package.json not found"
            exit 1
          fi
          npm ci --silent
          npm run build
          
          # Verify frontend build
          if [ ! -d "dist" ]; then
            echo "âŒ Frontend build failed - dist directory not found"
            exit 1
          fi
          
          # Copy frontend build to backend public
          echo "ğŸ“‚ Copying frontend build..."
          rm -rf ../backend/public
          cp -r dist ../backend/public
          
          cd ..
          
          # Update current symlink
          cd ${{ env.DEPLOY_PATH }}
          rm -f current
          ln -sf fuseloja current
          
          # Setup environment
          cd current/backend
          if [ ! -f .env ]; then
            echo "âš™ï¸ Creating environment file..."
            cat > .env << EOF
          NODE_ENV=production
          PORT=3000
          FRONTEND_URL=https://www.fuseloja.com.br
          DB_HOST=${{ secrets.DB_HOST || 'localhost' }}
          DB_PORT=${{ secrets.DB_PORT || '5432' }}
          DB_NAME=${{ secrets.DB_NAME || 'fuseloja' }}
          DB_USER=${{ secrets.DB_USER || 'postgres' }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD || 'postgres' }}
          JWT_SECRET=${{ secrets.JWT_SECRET || 'change-this-secret-in-production' }}
          EOF
          fi
          
          # Install PM2 if not exists
          if ! command -v pm2 &> /dev/null; then
            echo "ğŸ“¦ Installing PM2..."
            npm install -g pm2
          fi
          
          # Start/restart application
          echo "ğŸ”„ Starting application..."
          pm2 delete ${{ env.APP_NAME }} 2>/dev/null || true
          pm2 start src/index.js --name ${{ env.APP_NAME }} --env production
          pm2 save
          
          # Setup PM2 startup (if first time)
          pm2 startup systemd -u $USER --hp /home/$USER 2>/dev/null || true
          
          echo "âœ… Deployment completed!"
          
          # Health check
          echo "ğŸ” Running health check..."
          sleep 10
          if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed"
            pm2 logs ${{ env.APP_NAME }} --lines 20
            exit 1
          fi

    - name: ğŸ” Verify Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        script: |
          echo "ğŸ” Deployment verification..."
          
          # Check PM2 status
          echo "ğŸ“Š PM2 Status:"
          pm2 status ${{ env.APP_NAME }}
          
          # Check application logs
          echo "ğŸ“‹ Recent logs:"
          pm2 logs ${{ env.APP_NAME }} --lines 10 --nostream
          
          # Test endpoints
          echo "ğŸŒ Testing endpoints..."
          curl -s http://localhost:3000/health | jq '.' || echo "Health endpoint OK"
          curl -s http://localhost:3000/ | head -5 || echo "Root endpoint OK"
          
          echo "âœ… Verification completed!"

    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Server:** ${{ secrets.VPS_HOST }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ env.COMMIT_HASH }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL:** https://www.fuseloja.com.br" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸŒ Website](https://www.fuseloja.com.br)" >> $GITHUB_STEP_SUMMARY
        echo "- [â¤ï¸ Health Check](http://${{ secrets.VPS_HOST }}:3000/health)" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ“Š API Status](http://${{ secrets.VPS_HOST }}:3000/)" >> $GITHUB_STEP_SUMMARY

  notify:
    name: ğŸ“¢ Notify Results
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¢ Success Notification
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "âœ… Application is live at https://www.fuseloja.com.br"
        
    - name: ğŸš¨ Failure Notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ Deployment failed!"
        echo "Check the logs above for details."
        exit 1