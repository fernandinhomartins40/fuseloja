name: üö® Emergency Frontend Fix

on:
  workflow_dispatch:

jobs:
  emergency-fix:
    name: üö® Emergency Fix
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json

    - name: üèóÔ∏è Build Frontend
      working-directory: ./frontend
      run: |
        npm ci --silent
        npm run build
        echo "‚úÖ Frontend build completed"
        ls -la dist/

    - name: üìÇ Copy Frontend to Backend
      run: |
        rm -rf backend/public
        cp -r frontend/dist backend/public
        echo "‚úÖ Frontend copied to backend/public"
        ls -la backend/public/

    - name: üö® Emergency Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 300s
        script: |
          echo "üö® EMERGENCY FRONTEND FIX"
          echo "========================"
          
          # Kill all node processes
          echo "üõë Stopping all applications..."
          pm2 delete all 2>/dev/null || echo "No PM2 processes"
          pkill -f node 2>/dev/null || echo "No node processes"
          sleep 3
          
          # Check if frontend files exist
          echo "üìÅ Checking frontend files..."
          ls -la /opt/fuseloja/current/backend/public/ 2>/dev/null || echo "‚ùå Frontend files missing!"
          
          # Create a simple test HTML if frontend is missing
          if [ ! -f "/opt/fuseloja/current/backend/public/index.html" ]; then
            echo "üîß Creating emergency frontend..."
            mkdir -p /opt/fuseloja/current/backend/public
            cat > /opt/fuseloja/current/backend/public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>FuseLoja - Em Manuten√ß√£o</title>
              <style>
                  body { 
                      font-family: Arial, sans-serif; 
                      text-align: center; 
                      padding: 50px; 
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      margin: 0;
                  }
                  .container {
                      max-width: 600px;
                      margin: 0 auto;
                      background: rgba(255,255,255,0.1);
                      padding: 40px;
                      border-radius: 15px;
                      backdrop-filter: blur(10px);
                  }
                  h1 { font-size: 2.5em; margin-bottom: 20px; }
                  p { font-size: 1.2em; line-height: 1.6; }
                  .status { 
                      background: rgba(255,255,255,0.2); 
                      padding: 20px; 
                      border-radius: 10px; 
                      margin: 20px 0; 
                  }
                  .api-link { 
                      color: #ffd700; 
                      text-decoration: none; 
                      font-weight: bold; 
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üè™ FuseLoja</h1>
                  <p>Site em manuten√ß√£o tempor√°ria</p>
                  <div class="status">
                      <p><strong>Status:</strong> Configurando frontend...</p>
                      <p><strong>Backend:</strong> ‚úÖ Funcionando</p>
                      <p><strong>API:</strong> <a href="/api" class="api-link">Dispon√≠vel</a></p>
                  </div>
                  <p>Voltaremos em breve com a experi√™ncia completa!</p>
              </div>
          </body>
          </html>
          EOF
            echo "‚úÖ Emergency frontend created"
          fi
          
          # Navigate to backend
          cd /opt/fuseloja/current/backend
          
          # Start with minimal configuration
          echo "üöÄ Starting optimized application..."
          NODE_ENV=production \
          PORT=3000 \
          pm2 start src/index.js \
            --name fuseloja-minimal \
            --instances 1 \
            --max-memory-restart 256M \
            --node-args="--max-old-space-size=256" \
            --time
          
          # Save configuration
          pm2 save
          
          echo "‚è±Ô∏è Waiting for startup..."
          sleep 10
          
          # Test application
          echo "üß™ Testing application..."
          
          # Test health endpoint
          if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            echo "‚úÖ Health check: PASSED"
          else
            echo "‚ùå Health check: FAILED"
          fi
          
          # Test frontend
          if curl -f http://localhost:3000/ > /dev/null 2>&1; then
            echo "‚úÖ Frontend: ACCESSIBLE"
          else
            echo "‚ùå Frontend: FAILED"
          fi
          
          # Test API
          if curl -f http://localhost:3000/api > /dev/null 2>&1; then
            echo "‚úÖ API: ACCESSIBLE"
          else
            echo "‚ùå API: FAILED"
          fi
          
          # Show status
          echo "üìä Final status:"
          pm2 status fuseloja-minimal
          
          echo "‚úÖ Emergency fix completed!"

    - name: üì§ Upload New Frontend Files
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        source: "backend/public/*"
        target: "/opt/fuseloja/current/backend/"
        strip_components: 1

    - name: üîÑ Restart with New Frontend
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        script: |
          echo "üîÑ Restarting with fresh frontend..."
          
          # Verify frontend files
          ls -la /opt/fuseloja/current/backend/public/
          
          # Restart PM2
          pm2 restart fuseloja-minimal
          
          # Wait and test
          sleep 5
          
          echo "üß™ Final verification..."
          curl -I http://localhost:3000/ || echo "Test failed"
          
          echo "‚úÖ All done! Check https://www.fuseloja.com.br"