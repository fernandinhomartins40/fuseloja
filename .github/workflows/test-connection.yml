name: ðŸ§ª Test VPS Connection

on:
  workflow_dispatch:

jobs:
  test-connection:
    name: ðŸ” Test VPS Connection
    runs-on: ubuntu-latest
    
    steps:
    - name: âœ… Check VPS_PASSWORD Secret
      run: |
        echo "## ðŸ” VPS Connection Test" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ secrets.VPS_PASSWORD }}" ]; then
          echo "- âœ… VPS_PASSWORD: Configured" >> $GITHUB_STEP_SUMMARY
          echo "âœ… VPS_PASSWORD secret is configured"
        else
          echo "- âŒ VPS_PASSWORD: Missing" >> $GITHUB_STEP_SUMMARY
          echo "âŒ VPS_PASSWORD secret is missing"
          echo "::error::VPS_PASSWORD secret is required"
          exit 1
        fi

    - name: ðŸ”Œ Test SSH Connection
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 82.25.69.57
        username: root
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 30s
        script: |
          echo "ðŸ”Œ Testing SSH connection to fuseloja.com.br VPS..."
          echo "ðŸ“Š Server Info:"
          echo "- Hostname: $(hostname)"
          echo "- OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '\"')"
          echo "- Uptime: $(uptime -p)"
          echo "- Disk Space: $(df -h / | tail -1 | awk '{print $4}') available"
          echo "- Memory: $(free -h | grep Mem | awk '{print $7}') available"
          
          echo ""
          echo "ðŸ” Checking required software..."
          
          if command -v node &> /dev/null; then
            echo "âœ… Node.js: $(node --version)"
          else
            echo "âš ï¸ Node.js: Not installed"
          fi
          
          if command -v pm2 &> /dev/null; then
            echo "âœ… PM2: $(pm2 --version)"
          else
            echo "âš ï¸ PM2: Not installed"
          fi
          
          if command -v psql &> /dev/null; then
            echo "âœ… PostgreSQL: Available"
          else
            echo "âš ï¸ PostgreSQL: Not installed"
          fi
          
          echo ""
          echo "ðŸ“‚ Checking deployment directory..."
          if [ -d "/opt/fuseloja" ]; then
            echo "âœ… /opt/fuseloja: Exists"
            if [ -d "/opt/fuseloja/current" ]; then
              echo "âœ… Current deployment: Found"
            else
              echo "âš ï¸ Current deployment: Not found"
            fi
          else
            echo "âš ï¸ /opt/fuseloja: Not found"
          fi
          
          echo ""
          echo "ðŸš€ VPS is ready for FuseLoja deployment!"

    - name: ðŸ“Š Generate Summary
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Connection Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Host**: 82.25.69.57" >> $GITHUB_STEP_SUMMARY
        echo "- **Username**: root" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain**: fuseloja.com.br" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "### âœ… Connection Test Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your VPS is ready for deployment. You can now:" >> $GITHUB_STEP_SUMMARY
          echo "1. Push code to main branch for automatic deploy" >> $GITHUB_STEP_SUMMARY
          echo "2. Run 'Deploy FuseLoja' workflow manually" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Connection Test Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check:" >> $GITHUB_STEP_SUMMARY
          echo "1. VPS_PASSWORD secret is correct" >> $GITHUB_STEP_SUMMARY
          echo "2. VPS is accessible: \`ssh root@82.25.69.57\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Password authentication is enabled on VPS" >> $GITHUB_STEP_SUMMARY
        fi