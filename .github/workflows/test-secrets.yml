name: Test VPS Secrets Configuration

on:
  workflow_dispatch:
    inputs:
      test_connection:
        description: 'Test SSH connection to VPS'
        required: false
        default: false
        type: boolean

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check VPS Secrets Configuration
      run: |
        echo "ğŸ” TESTING VPS SECRETS CONFIGURATION"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Test required secrets
        echo "ğŸ“‹ REQUIRED SECRETS:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        MISSING_SECRETS=""
        CONFIGURED_SECRETS=""
        
        # Check VPS_HOST
        if [ -z "${{ secrets.VPS_HOST }}" ]; then
          echo "âŒ VPS_HOST: Missing"
          MISSING_SECRETS="$MISSING_SECRETS VPS_HOST"
        else
          echo "âœ… VPS_HOST: Configured (${#{{ secrets.VPS_HOST }}} chars)"
          CONFIGURED_SECRETS="$CONFIGURED_SECRETS VPS_HOST"
        fi
        
        # Check VPS_USERNAME
        if [ -z "${{ secrets.VPS_USERNAME }}" ]; then
          echo "âŒ VPS_USERNAME: Missing"
          MISSING_SECRETS="$MISSING_SECRETS VPS_USERNAME"
        else
          echo "âœ… VPS_USERNAME: Configured (${#{{ secrets.VPS_USERNAME }}} chars)"
          CONFIGURED_SECRETS="$CONFIGURED_SECRETS VPS_USERNAME"
        fi
        
        # Check authentication method
        HAS_PASSWORD=""
        HAS_SSH_KEY=""
        
        if [ -n "${{ secrets.VPS_PASSWORD }}" ]; then
          echo "âœ… VPS_PASSWORD: Configured (${#{{ secrets.VPS_PASSWORD }}} chars)"
          HAS_PASSWORD="yes"
          CONFIGURED_SECRETS="$CONFIGURED_SECRETS VPS_PASSWORD"
        else
          echo "âŒ VPS_PASSWORD: Missing"
        fi
        
        if [ -n "${{ secrets.VPS_SSH_KEY }}" ]; then
          echo "âœ… VPS_SSH_KEY: Configured (${#{{ secrets.VPS_SSH_KEY }}} chars)"
          HAS_SSH_KEY="yes"
          CONFIGURED_SECRETS="$CONFIGURED_SECRETS VPS_SSH_KEY"
        else
          echo "âŒ VPS_SSH_KEY: Missing"
        fi
        
        if [ -z "$HAS_PASSWORD" ] && [ -z "$HAS_SSH_KEY" ]; then
          echo "âŒ AUTHENTICATION: Neither VPS_PASSWORD nor VPS_SSH_KEY configured"
          MISSING_SECRETS="$MISSING_SECRETS VPS_AUTH_METHOD"
        else
          echo "âœ… AUTHENTICATION: Method available"
        fi
        
        echo ""
        echo "ğŸ“‹ OPTIONAL SECRETS:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        # Check optional secrets
        if [ -n "${{ secrets.VPS_PORT }}" ]; then
          echo "âœ… VPS_PORT: Configured (${{ secrets.VPS_PORT }})"
        else
          echo "â„¹ï¸  VPS_PORT: Using default (22)"
        fi
        
        if [ -n "${{ secrets.JWT_SECRET }}" ]; then
          echo "âœ… JWT_SECRET: Configured (${#{{ secrets.JWT_SECRET }}} chars)"
        else
          echo "âš ï¸  JWT_SECRET: Missing (will use default - not recommended for production)"
        fi
        
        if [ -n "${{ secrets.JWT_REFRESH_SECRET }}" ]; then
          echo "âœ… JWT_REFRESH_SECRET: Configured (${#{{ secrets.JWT_REFRESH_SECRET }}} chars)"
        else
          echo "âš ï¸  JWT_REFRESH_SECRET: Missing (will use default - not recommended for production)"
        fi
        
        if [ -n "${{ secrets.EMAIL_USER }}" ]; then
          echo "âœ… EMAIL_USER: Configured (${{ secrets.EMAIL_USER }})"
        else
          echo "â„¹ï¸  EMAIL_USER: Missing (email features disabled)"
        fi
        
        if [ -n "${{ secrets.EMAIL_PASSWORD }}" ]; then
          echo "âœ… EMAIL_PASSWORD: Configured (${#{{ secrets.EMAIL_PASSWORD }}} chars)"
        else
          echo "â„¹ï¸  EMAIL_PASSWORD: Missing (email features disabled)"
        fi
        
        echo ""
        echo "ğŸ“‹ VARIABLES:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        if [ -n "${{ vars.DOMAIN }}" ]; then
          echo "âœ… DOMAIN: Configured (${{ vars.DOMAIN }})"
        else
          echo "â„¹ï¸  DOMAIN: Missing (will use default)"
        fi
        
        if [ -n "${{ vars.CORS_ORIGINS }}" ]; then
          echo "âœ… CORS_ORIGINS: Configured (${{ vars.CORS_ORIGINS }})"
        else
          echo "â„¹ï¸  CORS_ORIGINS: Missing (will use default)"
        fi
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Summary
        if [ -n "$MISSING_SECRETS" ]; then
          echo "ğŸš¨ CONFIGURATION STATUS: INCOMPLETE"
          echo ""
          echo "Missing required secrets:$MISSING_SECRETS"
          echo ""
          echo "ğŸ“ TO FIX:"
          echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "2. Click 'New repository secret'"
          echo "3. Add each missing secret listed above"
          echo ""
          echo "ğŸ“– Documentation: .github/DEPLOY_SECRETS.md"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
        else
          echo "âœ… CONFIGURATION STATUS: COMPLETE"
          echo ""
          echo "All required secrets are configured!"
          echo "Configured secrets:$CONFIGURED_SECRETS"
          echo ""
          if [ -n "$HAS_SSH_KEY" ]; then
            echo "ğŸ” Using SSH Key authentication (recommended)"
          else
            echo "ğŸ” Using Password authentication"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        fi

    - name: Test SSH Connection
      if: ${{ github.event.inputs.test_connection == 'true' && secrets.VPS_HOST != '' && secrets.VPS_USERNAME != '' }}
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        timeout: 30s
        script: |
          echo "ğŸ”Œ SSH CONNECTION TEST"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… SSH connection successful!"
          echo "ğŸ–¥ï¸  Server: $(hostname)"
          echo "ğŸ‘¤ User: $(whoami)"
          echo "ğŸ“‚ Current directory: $(pwd)"
          echo "ğŸ³ Docker: $(docker --version 2>/dev/null || echo 'Not installed')"
          echo "ğŸ“¦ Git: $(git --version 2>/dev/null || echo 'Not installed')"
          echo "ğŸ’¾ Disk space: $(df -h / | tail -1 | awk '{print $4}') available"
          echo "ğŸ§  Memory: $(free -h | grep Mem | awk '{print $7}') available"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Check if deploy directory exists
          if [ -d "/opt/fuseloja-fullstack" ]; then
            echo "ğŸ“ Deploy directory: EXISTS"
          else
            echo "ğŸ“ Deploy directory: NOT FOUND (will be created during deploy)"
          fi
          
          # Check Docker permissions
          if docker ps > /dev/null 2>&1; then
            echo "ğŸ³ Docker permissions: OK"
          else
            echo "âš ï¸  Docker permissions: Limited (may need sudo)"
          fi

    - name: Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ¯ NEXT STEPS:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        if [ -z "${{ secrets.VPS_HOST }}" ] || [ -z "${{ secrets.VPS_USERNAME }}" ]; then
          echo "1. âŒ Configure missing secrets first"
          echo "2. ğŸ”„ Re-run this test workflow"
          echo "3. ğŸš€ Then try the deploy workflow"
        else
          if [ "${{ github.event.inputs.test_connection }}" == "true" ]; then
            echo "1. âœ… Secrets and connection tested"
            echo "2. ğŸš€ Ready for deployment!"
            echo "3. ğŸ“¤ Push to main branch or run deploy workflow manually"
          else
            echo "1. âœ… Secrets configured"
            echo "2. ğŸ”Œ Optionally test SSH connection (re-run with test_connection=true)"
            echo "3. ğŸš€ Ready for deployment!"
          fi
        fi
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"